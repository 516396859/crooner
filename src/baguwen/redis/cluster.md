---
title: Redis 集群
icon: file
author: Cheney
date: 2024-05-05
isOriginal: true
category: 中间件
order: 2
---


### 1. Redis的故障发现的原理知道吗？
Redis集群内节点通过ping/pong消息实现节点通信，集群中每个节点都会定期向其他节点发送ping消息，接收节点回复pong 消息作为响应。如果在超时时间内通信一直失败，则发送节点会认为接收节点存在故障，把接收节点标记为主观下线（pfail）状态。 当某个节点判断另一个节点主观下线后，相应的节点状态会跟随消息在集群内传播。通过Gossip消息传播，集群内节点不断收集到故障节点的下线报告。当半数以上持有槽的主节点都标记某个节点是主观下线时。触发客观下线流程。

---

### 2. Redis Cluster 集群方案什么情况下会导致整个集群不可用？
Redis 没有使用哈希一致性算法，而是使用哈希槽。Redis 中的哈希槽一共有 16384 个，计算给定key的哈希槽，我们只需要对key的 CRC16 取摸 16384。假设集群中有 A、B、C 三个集群节点，不存在复制模式下，每个集群的节点包含的哈希槽如下：节点 A 包含从 0 到 5500 的哈希槽；节点 B 包含从 5501 到 11000 的哈希槽；节点 C 包含从 11001 到 16383 的哈希槽；这时，如果节点 B 出现故障，整个集群就会出现缺少 5501 到 11000 的哈希槽范围而不可用。因此，避免整个集群不可用的最佳实践是对每个哈希槽分片进行备份。

---

### 3. 为什么要用缓存，用缓存带来什么问题？
- 缓存带来高并发（多）、高性能（快），上万QPS轻轻松松。
- 带来了雪崩、穿透、数据一致性等问题。

---

### 4. 是否使用过 Redis Cluster 集群，集群的原理是什么？
每个集群节点中都有一个主节点和多个从节点，Cluster不需要哨兵，因为各个集群的主节点相互通信来确认存活。各个节点的联通是通过 CLUSTER MEET 命令完成的。将所有的存储空间计划切割成16384份，每个集群主机保存一部分注意：每份代表的是一个存储空间，不是一个key的保存空间。Redis 集群中内置了 16384 个哈希槽，当需要在 Redis 集群中放置一个 key-value 时，redis 先对key 使用 crc16 算法算出一个结果，然后把结果对 16384 求余数，这样每个 key 都会对应一个编号在 0~16383 之间的哈希槽，redis 会根据节点数量大致均等的将哈希槽映射到不同的节点。 各个数据库相互通信，保存各个库中槽的编号数据 。集群节点不会代理查询 ，集群节点挂掉会自动故障转移 。

---

### 5. 什么是setinel，sentinel 有啥用？
监控各个节点的节点，当master出现了故障会重新选择新的master进行故障转移，然后通知其他slave新的master的连接信息。

---

### 6. 如何检测节点是否下线？
采用的是心跳机制哨兵向各个节点发生PING命令，分为主观下线和客观下线；主观下线是某个Sentinal节点认为下线了是主观下线，客观下线是指定是法定数量（数量过半）的哨兵节点认为某个节点已经下线那就是客观下线；只有客观下线了才会选择新的master。

---

### 7. Sentinel 优先选择什么样的master？
按照优先级选择：优先在线的 > 备份最完整的 > runid最小的，还可以设置slave的优先级

---

### 8. 如何从 Sentinel 集群中选择出 Leader ？
使用的是分布式领域的Raft共识算法。具体请参考分布式原理篇章！

---

### 9. 为什么需要 Cluster？ Cluster集群与Sentinel 集群区别？
现在的数据量太大了，单机存不下，而且Sentinel只有一个主节点其他都是从节点用于备份的，保证的是高可用性。Cluster每个小群都有一个主，存放不同的数据，有不同的哈希槽，用于扩展数据，保证数据的高扩展性与高可用性。

---

### 10. Redis Cluster 是如何分片的？| Redis Cluster 中的数据是如何分布的？| 如何确定给定 key 的应该分布到哪个哈希槽中？
Redis Cluster 并没有使用一致性哈希，采用的是哈希槽分区 ，每一个键值对都属于一个哈希槽当客户端发送命令请求的时候，需要先根据 key 通过CRC16算法找到的对应的哈希槽，然后再查询哈希槽和节点的映射关系，即可找到目标节点。而每个master内部维护了哈希槽路由表，即每个master对应的哈希槽值分布。

---

### 11. Redis Cluster 扩容缩容期间可以提供服务吗？
可以，如果客户端请求的 key 对应的哈希槽已经迁移完成的话，就会返回**重定向错误**，告知客户端当前哈希槽是由哪个节点负责，客户端向**新节点发送请求**并更新缓存的哈希槽分配信息，后续查询将被发送到新节点。

---

### 12. Redis Cluster 中的节点是怎么进行通信的？
集群中的每个节点都会单独开辟一个TCP通道， 用于节点之间彼此通信。每个节点在固定周期内通过特定规则选择几个节点发送ping消息。接收到ping消息的节点用pong消息作为响应。集群中每个节点通过一定规则挑选要通信的节点， 每个节点可能知道全部节点， 也可能仅知道部分节点， 只要这些节点彼此可以正常通信， 最终它们会达到一致的状态。 当节点出故障、 新节点加入、 主从角色变化、 槽信息变更等事件发生时， 通过不断的ping/pong消息通信， 经过一段时间后所有的节点都会知道整个集群全部节点的最新状态， 从而达到集群状态同步的目的。

---


### 13. Redis 集群架构模式有哪几种？
- 哨兵模式：哨兵模式也是为了提供高可用而设计的，这种模式中多个redis实例，其中一个为主节点，其他为从节点。哨兵们监控着各个节点的状态，当主节点宕机了会从从节点中选出新的节点作为主节点。
- 集群模式：集群模式是为了数据扩展与分片而设计的，这种模式是由多个节点群组成，每个节点群只有一个主节点，每个群负责一部分数据。每个节点群的主节点相互发送心跳，判断其他主节点的状态。

>[!important]
> - Sentinal 哨兵模式需要引进哨兵服务器进行状态监督与主选举，着眼于高可用，哨兵不需要和主机一对一，可以多对多。缺点没有解决master写的压力。一个master多个slave。每台机子存储相同的数据。
> - Cluster 着眼于扩展性，内存不足可以分片存储。一个主从簇中每台节点存储不同的数据，采用多主多从解决了master写的压力。

---



