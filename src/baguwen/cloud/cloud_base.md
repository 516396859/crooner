---
title: 分布式基本理论
icon: file
author: Cheney
date: 2024-05-06
isOriginal: true
category: Java
order: 1
---

### 1. CAP理论
CAP也就是一致性、可用性、分区容错性三个单词的首字母。CAP理论讲的是当网络发生分区时，为了保证分区容错性前提下，那么一致性和可用性只能2选1，也就是所谓的PA还是PC问题。那么当网络正常不会发生分区（也就是单机或者集群服务）的情况下，可用性和一致性都能保证。

**为什么在保证分区容错性P的前提下，无法满足一致性C和可用性A？**
- 分区容错性：在网络分区的情况下，被分隔的节点仍能正常对外服务。
- 数据一致性：如果系统对一个写操作返回成功，那么之后的读请求都必须读到这个新数据。
- 系统可用性：所有读写请求在一定时间内得到响应，可终止、不会一直等待。

假设现在分区容错，整个网络分为A，B两块。为了保证数据一致性，不能对分区进行写操作，因为只要写了两个分区的数据就不一致。但是不能写操作肯定是破坏了系统可用性的。如果保证系统可用性，就应该运行写操作，但是允许写操作就破坏了数据一致性要求。因此这两者不可兼得！

---

### 2. BASE理论
因为CAP理论说CA和CP无法兼得，那么保证基本可用或者最终一致性可不可以？这就是BASE理论提出的基础。BASE 理论是对 CAP 中一致性 C 和可用性 A 权衡的结果，它大大降低了我们对系统的要求。是对 CAP 的延伸和补充。它包含三点：
- 基本可用：当系统出现分区时，允许损失部分可用性，例如延迟响应，非核心功能不可用。
- 软状态：数据中间过程中不一致的状态，或者运行中间数据副本同步存在延时。
- 最终一致性：不需要时时保证数据强一致性，中间某个状态可以不一致但是最终能够达到一个一致性状态。例如在线人数显示，可以某个时刻返回旧数据，但是可能一段延时3秒后就更新了正确的数据。

**分布式一致性的三个级别：**
- 强一致性：写什么读到的就是什么，时时同步，时时一致；
- 弱一致性：运行使用旧数据，运行同步过程存在延时；
- 最终一致性：弱一致性只是暂时的，最后经过一段时间达到最终一致性；

---

### 3. Reft算法理论
Reft 算法是分布式架构下的共识算法，用来选出主节点然后向其他节点发送指令完成数据同步，例如Redis Cluster，Nacos、RabbitMQ等集群都是通过Reft算法来确认master的。首先明确几个概念：
- 一开始每个节点都应该是平等的。
- 节点状态分为 领导者，追随者，候选者。
- 使用 term 任期表示一个阶段担任主节点的时间段，计数器。
- 每个追随者等待领导者心跳回应的超时时间是随机的。（降低同时成为候选者的几率）
假设有A，B，C节点，超时时间分别是100ms，200ms，300ms

**投票阶段：**
1. 首先没有领导者，A会先超时，此时A成为候选者，然后将term+1，给其他节点发出投票请求并给自己投票。向远程的其他节点发起RPC投票请求。
2. 其他节点在此任期内如果没有投过票，就把票投给A，并将任期也加一。
3. 当节点A的票数大于等于 n/2+1 时成为领导者，选举完成。
4. A作为领导者需要每隔固定时间给其他追随者发送心跳信息，确认子节点或者。
5. 当子节点在一个超时时间内没收到A的心跳信息，则开始造反，成为候选者开启选举。
注意：任期是自增的，投票有限投给任期大的，当一个主节点宕机恢复后如果任期比新的心跳信息节点任期小则自动成为它的追随者。一般出现在分区错误恢复后。节点接到投票请求发现比自己的任期还小则投拒绝票。只能是主节点宕机或者网络延迟了，其他追随者超时才能成为候选者。如果两个节点同时成为候选者则比票数，票数一样则继续纠缠，直到其他追随者也超时开启新的任期成为新的领导者。如果由于网络延时导致节点造反，那么当它收到pong后，发现对方的任期>=自己的任期就回退为追随者。

---
